<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Centomilamilardi di Spettacoli di Teatro Sociale </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Courier+Prime:ital,wght@0,400;0,700;1,400&family=Oswald:wght@500;700&display=swap');

        body {
            background-color: #f0f0f0;
            color: #1a1a1a;
            font-family: 'Courier Prime', monospace;
            background-image: radial-gradient(#ccc 1px, transparent 1px);
            background-size: 20px 20px;
        }

        h1, h2, h3, button {
            font-family: 'Oswald', sans-serif;
            text-transform: uppercase;
        }

        .brutalist-box {
            border: 3px solid #000;
            box-shadow: 8px 8px 0px #000;
            background: white;
            transition: all 0.2s ease;
        }

        .brutalist-box:active {
            transform: translate(4px, 4px);
            box-shadow: 4px 4px 0px #000;
        }

        .input-field {
            border: 2px solid #000;
            padding: 10px;
            width: 100%;
            font-family: 'Courier Prime', monospace;
            margin-bottom: 1rem;
            background: #fff;
        }

        .input-field:focus {
            outline: none;
            background: #ffecec;
            border-color: #ff0000;
        }

        /* Checkbox Brutalista Custom */
        .checkbox-container {
            display: block;
            position: relative;
            padding-left: 35px;
            margin-bottom: 12px;
            cursor: pointer;
            font-size: 14px;
            user-select: none;
        }

        .checkbox-container input {
            position: absolute;
            opacity: 0;
            cursor: pointer;
            height: 0;
            width: 0;
        }

        .checkmark {
            position: absolute;
            top: 0;
            left: 0;
            height: 20px;
            width: 20px;
            background-color: #fff;
            border: 2px solid #000;
        }

        .checkbox-container:hover input ~ .checkmark {
            background-color: #ccc;
        }

        .checkbox-container input:checked ~ .checkmark {
            background-color: #ff0000;
        }

        .checkmark:after {
            content: "";
            position: absolute;
            display: none;
        }

        .checkbox-container input:checked ~ .checkmark:after {
            display: block;
            left: 5px;
            top: 1px;
            width: 7px;
            height: 12px;
            border: solid white;
            border-width: 0 3px 3px 0;
            transform: rotate(45deg);
        }

        .highlight-red {
            background-color: #ff0000;
            color: white;
            padding: 0 5px;
        }

        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #ff0000;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Stile per il contenuto generato */
        .script-content h3 {
            font-size: 1.5rem;
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
            border-bottom: 2px solid #000;
            display: inline-block;
            background: #000;
            color: #fff;
            padding: 0 10px;
        }

        .script-content strong {
            background-color: #ffff00; /* Evidenziatore giallo brutale */
            padding: 0 2px;
        }

        .script-content em {
            font-style: italic;
            color: #444;
        }

        .script-content ul {
            list-style-type: square;
            margin-left: 20px;
            margin-bottom: 1rem;
        }

        .script-content li {
            margin-bottom: 0.5rem;
        }
        
        .mode-badge {
            font-size: 0.7rem;
            padding: 2px 6px;
            border: 1px solid black;
            font-weight: bold;
            text-transform: uppercase;
        }
        .mode-offline { background-color: #ddd; color: #555; }
        .mode-online { background-color: #00ff00; color: #000; }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen flex flex-col items-center">

    <div class="max-w-3xl w-full">
        <!-- Header -->
        <header class="mb-8 text-center">
            <h1 class="text-4xl md:text-6xl font-bold bg-black text-white inline-block p-4 mb-2 transform -rotate-1">
                Centomilamilardi
            </h1>
            <h2 class="text-xl md:text-2xl font-bold bg-red-600 text-white inline-block p-2 transform rotate-1">
                Generatore Automatico per il Teatro Sociale
            </h2>
            <p class="mt-4 text-sm md:text-base italic">
                "La variabilità del disagio è infinita."
            </p>
        </header>

        <!-- Input Section -->
        <div class="brutalist-box p-6 mb-8 relative overflow-hidden">
            <h3 class="text-xl mb-4 border-b-2 border-black pb-2">1. Parametri Drammaturgici</h3>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div>
                    <label class="block mb-2 font-bold uppercase text-sm">Il Tema (Il Dolore)</label>
                    <input type="text" id="theme" class="input-field" placeholder="Es: Razzismo, Gentrificazione...">
                </div>
                <div>
                    <label class="block mb-2 font-bold uppercase text-sm">Il Luogo (La Ferita)</label>
                    <input type="text" id="place" class="input-field" placeholder="Es: Ex Macello, Sottopasso Tangenziale...">
                </div>
            </div>

            <h3 class="text-xl mb-4 border-b-2 border-black pb-2">2. Seleziona gli Ingredienti di Teatro Sociale</h3>
            <p class="text-xs mb-2 italic">Seleziona i "bug" artistici da sottendere alla costruzione dello spettacolo</p>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mb-6 bg-gray-100 p-4 border border-black">
                <label class="checkbox-container">Scenografie Ingombranti e Pericolose
                    <input type="checkbox" id="chk_metafore" value="metafore" checked>
                    <span class="checkmark"></span>
                </label>
                <label class="checkbox-container">Videoproiezioni / Disegno Live
                    <input type="checkbox" id="chk_video" value="video" checked>
                    <span class="checkmark"></span>
                </label>
                <label class="checkbox-container">Idealizzazione del Marginale
                    <input type="checkbox" id="chk_idealizzazione" value="idealizzazione" checked>
                    <span class="checkmark"></span>
                </label>
                <label class="checkbox-container">Estetica Fragile (Recitazione scadente)
                    <input type="checkbox" id="chk_estetica" value="estetica" checked>
                    <span class="checkmark"></span>
                </label>
                <label class="checkbox-container">Fruizione Punitiva per gli spettatori
                    <input type="checkbox" id="chk_fruizione" value="fruizione" checked>
                    <span class="checkmark"></span>
                </label>
                <label class="checkbox-container">Moralismo Pedagogico
                    <input type="checkbox" id="chk_moralismo" value="moralismo" checked>
                    <span class="checkmark"></span>
                </label>
                <label class="checkbox-container">Visione Patriarcale e Paternalista del Regista
                    <input type="checkbox" id="chk_patriarcato" value="patriarcato" checked>
                    <span class="checkmark"></span>
                </label>
            </div>

            <button onclick="dispatchGeneration()" class="w-full bg-black text-white hover:bg-red-600 font-bold py-4 text-xl border-2 border-transparent hover:border-black transition-colors">
                GENERA SENSO DI COLPA
            </button>
        </div>

        <!-- API Config Section -->
        <div class="brutalist-box p-6 mb-8 bg-gray-50">
            <h3 class="text-xl mb-4 border-b-2 border-black pb-2 flex justify-between items-center">
                <span>Queste generatore è proletario e fa volutamente errori di sintassi e grammatica. Se sei un borghese e vuoi coerenza grammaticale e semantica, usa la fottuta intelligenza artificiale...</span>
                <span id="modeIndicator" class="mode-badge mode-offline">MODALITÀ OFFLINE</span>
            </h3>
            <p class="text-xs mb-2">Lascia vuoto per usare il generatore casuale, proletario e sgrammaticato. Altrimenti, inserisci la tua costosissima Chiave API OpenAI qui </p>
            <input type="password" id="apiKey" class="input-field mb-2" placeholder="sk-..." autocomplete="off" oninput="updateMode()">
            <button id="aiToggleBtn" onclick="toggleAI()" class="w-full bg-red-600 text-white font-bold py-2 text-sm border-2 border-black hover:bg-black hover:text-white transition-colors">
                Attiva IA (GPT)
            </button>
        </div>

        <!-- Loading State -->
        <div id="loadingSection" class="hidden text-center py-8">
            <div class="loader mb-4"></div>
            <p id="loadingText" class="text-lg font-bold animate-pulse">Reclutando figuranti non retribuiti...</p>
        </div>

        <!-- Output Section -->
        <div id="outputSection" class="hidden brutalist-box p-8 border-4 border-red-600 relative">
            <div class="absolute -top-5 left-1/2 transform -translate-x-1/2 bg-red-600 text-white px-4 py-2 font-bold text-lg border-2 border-black shadow-lg">
                SCHEDA ARTISTICA
            </div>
            <div id="scriptContent" class="script-content mt-4 text-justify">
                <!-- Il contenuto verrà iniettato qui -->
            </div>
            
            <div class="mt-8 pt-4 border-t-2 border-dashed border-gray-400 text-center space-y-2">
                <div class="flex flex-col md:flex-row md:justify-center md:space-x-4 space-y-2 md:space-y-0">
                    <button onclick="toggleEditMode()" class="text-sm underline hover:text-red-600">Modifica/Testo</button>
                    <button onclick="saveEditedContent()" class="text-sm underline hover:text-red-600">Salva Modifiche</button>
                    <button onclick="copyToClipboard()" class="text-sm underline hover:text-red-600">Copia Progetto</button>
                    <button onclick="exportPDF()" class="text-sm underline hover:text-red-600">Salva PDF</button>
                </div>
                <p id="editHint" class="text-xs italic text-gray-600 hidden">ModalitÇÿ modifica attiva: clicca nel testo e scrivi, poi premi "Salva Modifiche".</p>
            </div>
        </div>
    </div>

    <script>
        // --- GRAMMATICA GENERATIVA COMBINATORIA ---
        const LEXICON = {
            adj: [
                "fragile", "urgente", "necessario", "carsico", "poroso", "sbiancato", "meticcio", 
                "liminale", "periferico", "assente", "interrotto", "viscerale", "materico", 
                "indicibile", "sospeso", "doloroso", "collettivo", "sfilacciato", "arrugginito",
                "pre-politico", "post-umano", "clandestino", "sgraziato", "autentico", "marginale",
                "precario", "incandescente", "sporco", "gelido", "soffocante", "labirintico",
                "catastrofico", "residuo", "incompiuto", "provvisorio", "abusivo", "tossico",
                "ferito", "amputato", "silenzioso", "assordante", "liquido", "faticoso", "estenuante"
            ],
            noun: [
                "dispositivo", "coagulo", "ferita", "soglia", "attraversamento", "corpo a corpo",
                "maieutica", "sbiancamento", "residuo", "maceria", "habitus", "memoria",
                "radice", "confine", "margine", "abisso", "silenzio", "urlo", "inciampo",
                "fallimento", "resistenza", "rito", "liturgia", "assemblea", "barricata",
                "zattera", "nave", "muro", "polmone", "respiro", "assenza", "cicatrice",
                "cantiere", "archivio", "frammento", "relitto", "geografia", "sismografia", "fardello"
            ],
            verb: [
                "abitare", "sconfinare", "attraversare", "interrogare", "risignificare", "decostruire",
                "esporre", "violare", "ricucire", "disseppellire", "amplificare", "negare", 
                "accogliere", "respingere", "fratturare", "coagulare", "precipitare", "inabissarsi",
                "didascalizzare", "ferire", "suturare", "invadere", "sabotare", "occupare",
                "contaminare", "ibridare", "sfondare", "trattenere", "restituire", "mappare"
            ],
            materials: [
                "tubi innocenti arrugginiti", "lamiere ondulate taglienti", "sedie di formica spaiate",
                "bancali di legno marcio", "teli di plastica sporchi", "vecchi televisori a tubo catodico",
                "copertoni esausti", "valigie di cartone sfondate", "reti da pesca impigliate",
                "scarpe senza lacci", "libri bagnati", "calcinacci veri", "fusti di benzina vuoti",
                "cavi elettrici scoperti", "neon tremolanti", "sacchi di juta pieni di sabbia",
                "ghiaccio che si scioglie", "pane secco", "terra di cantiere", "bottiglie schiacciate",
                "vestiti dismessi", "rottami ferrosi", "nastro adesivo da pacchi", "cartongesso umido",
                "cassette della frutta marce", "filo spinato", "mattoni forati", "sabbia nera", "vetri rotti"
            ]
        };

        const DB = {
            titles_prefix: [
                "Oratorio per", "Liturgia di", "Requiem del", "Vangelo secondo il", "Arcipelago di", 
                "Atlante del", "Geografia del", "Cantico per", "Rovina del", "Anatomia di",
                "Diario Minimo del", "Cantiere per", "Utopia del", "Processo al", "Litania del", 
                "Archivio del", "Testimonianza del", "Passione di", "Eucarestia del", "Sinfonia di",
                "Lamento per", "Cronache dal", "Report da", "Piccoli cedimenti del", "Il Violino del",
                "L'Ultimo Icaro del", "La Tempesta di", "Il Labirinto di", "Buchi nel", "Il Naufragio del",
                "Sismografia del", "Ecografia del", "Radiografia del", "Autopsia del", "Archeologia del", 
                "Topografia del", "Vespri del", "Rosario di", "Odissea minima del", "Piccola apocalisse del",
                "Manuale di", "Esercizi di", "Quaderni del", "Voci dal", "Respiri di", "Macerie di",
                "Teoria del", "Pratica del", "Estetica del", "Politica del", "Poetica del", "Etica del"
            ],
            titles_suffix: [
                "Cemento", "Confine", "Respiro", "Silenzio", "Corpo", "Vuoto", "Margine", 
                "Suolo", "Ventre", "Ricordo", "Orizzonte", "Tempo", "Muro", "Grido",
                "Naufragio", "Rifiuto", "Sonno", "Sangue", "Ferro", "Viaggio", "Passo",
                "Abisso", "Buio", "Fango", "Vetro", "Filo Spinato", "Polvere", "Ghiaccio",
                "Cemento Armato", "Anime Perse", "Respiro Interrotto", "Corpo Sgretolato", 
                "Vuoto Pneumatico", "Ventre Freddo", "Mare di Plastica", "Vento Contrario",
                "Rifiuto Solido", "Cielo di Piombo", "Sangue e Catrame", "Ferro Vecchio",
                "Passo Falso", "Radice Estirpata", "Asfalto Bollente", "Acqua Sporca",
                "Dimenticatoio", "Discarica", "Periferia", "Esilio", "Nostalgia", "Rancore"
            ],
            
            subtitles_templates: [
                "ovvero: Indagine scenica su [THEME]",
                "ovvero: Piccolo manuale di resistenza al [THEME]",
                "ovvero: Tentativo di esaurimento del concetto di [THEME]",
                "ovvero: Appunti per una drammaturgia del [THEME]",
                "ovvero: [THEME] come pratica di cittadinanza radicale",
                "ovvero: Esercizi spirituali per sopravvivere al [THEME]",
                "ovvero: Cosa resta del [THEME] quando si spengono le luci",
                "ovvero: Studio per corpi, macerie e [THEME]",
                "ovvero: Liturgia laica sul tema del [THEME]",
                "ovvero: Come abbiamo imparato a non temere il [THEME]",
                "ovvero: Una mappatura emotiva del [THEME]",
                "ovvero: Il [THEME] spiegato ai pesci e agli architetti",
                "ovvero: Dispositivo per l'elaborazione collettiva del [THEME]",
                "ovvero: Tracce di [THEME] in un paesaggio post-umano",
                "ovvero: [THEME] e altre catastrofi quotidiane",
                "ovvero: Breve storia del [THEME] per non addetti ai lavori",
                "ovvero: Quando il [THEME] diventa paesaggio",
                "ovvero: Per una pedagogia del [THEME]",
                "ovvero: Il [THEME] come forma di preghiera urbana",
                "ovvero: Istantanee di [THEME] dal sottosuolo",
                "ovvero: Il [THEME] visto da chi non ha voce",
                "ovvero: Strategie di sopravvivenza al [THEME]",
                "ovvero: Il [THEME] e l'arte di scomparire",
                "ovvero: Dialoghi impossibili sul [THEME]",
                "ovvero: Il [THEME] come ferita aperta",
                "ovvero: Non c'è mai posto sulla scialuppa per tutti",
                "ovvero: Tentativo di volo sopra i muri del [THEME]",
                "ovvero: Chi ha diritto a mettere radici nel [THEME]?",
                "ovvero: Cronaca di un [THEME] annunciato",
                "ovvero: Istruzioni per l'uso del [THEME]",
                "ovvero: [THEME] o barbarie",
                "ovvero: Il [THEME] ai tempi del colera sociale",
                "ovvero: Prove tecniche di [THEME]",
                "ovvero: Variazioni sul tema del [THEME]",
                "ovvero: Requiem per il [THEME] che non c'è più"
            ],

            places_templates: [
                "Abbiamo scelto di abitare <strong>[PLACE]</strong> perché qui il [THEME] è tangibile come una [NOUN] [ADJ].",
                "L'evento invade gli spazi di <strong>[PLACE]</strong>, trasformandolo in un dispositivo [ADJ] che interroga il [THEME].",
                "Non un palcoscenico, ma <strong>[PLACE]</strong>: un luogo che [VERB] il [THEME] e ci costringe a [VERB] le nostre certezze.",
                "Siamo andati a cercare l'invisibile presso <strong>[PLACE]</strong>, trovando solo [THEME] e [MATERIAL].",
                "Lo spettacolo è site-specific, nato dalle viscere di <strong>[PLACE]</strong>, inteso come [NOUN] del [THEME].",
                "Occupiamo <strong>[PLACE]</strong> per restituirlo alla città come [NOUN] [ADJ]. Un atto di [NOUN] contro il [THEME].",
                "La performance si snoda dentro <strong>[PLACE]</strong>, che diventa una macchina [ADJ] per processare il [THEME].",
                "In <strong>[PLACE]</strong>, considerato dalle mappe come [ADJ], abbiamo fondato una repubblica del [THEME].",
                "Questo <strong>[PLACE]</strong>, solitamente [ADJ], stasera diventa la culla di una nuova umanità scalza.",
                "Recitare in <strong>[PLACE]</strong> significa accettare che lo spazio è [ADJ] e che noi siamo intrusi.",
                "Abbiamo forzato i lucchetti di <strong>[PLACE]</strong> per mostrare che è [ADJ]. Un atto illegale ma eticamente necessario.",
                "Il rito si consuma nel ventre di <strong>[PLACE]</strong>, un non-luogo che abbiamo ribattezzato come [ADJ] per l'occasione.",
                "<strong>[PLACE]</strong> sanguina [MATERIAL], rendendo impossibile ignorare il [THEME].",
                "Trasformiamo <strong>[PLACE]</strong> in un archivio vivente del [THEME], usando solo [MATERIAL]."
            ],

            device_templates: [
                "Una struttura enorme fatta di [MATERIAL] che [ACTION] minacciosamente sopra il pubblico, simboleggiando il [THEME].",
                "Un labirinto costruito con [MATERIAL] che costringe gli attori a un continuo [NOUN] fisico con il [THEME].",
                "Una montagna di [MATERIAL] che viene scalata e distrutta ciclicamente, rappresentando la fatica del [THEME].",
                "Un muro di [MATERIAL] che separa la platea dagli attori, creando un senso di [NOUN] [ADJ] tipico del [THEME].",
                "Una zattera precaria assemblata con [MATERIAL] che naviga in un mare di [MATERIAL], evocando il [THEME].",
                "Un totem gigante di [MATERIAL] che vibra ed emette suoni [ADJ] legati al [THEME].",
                "Un sistema di carrucole che solleva [MATERIAL] sopra le teste degli spettatori, evocando il peso schiacciante del [THEME].",
                "Una gabbia fatta di [MATERIAL] al cui interno si svolge tutto il rito del [THEME].",
                "Una diga di [MATERIAL] che perde acqua sporca ritmicamente, minacciando di allagare la prima fila e il [THEME].",
                "Un ponte tibetano fatto di [MATERIAL], sospeso a tre metri d'altezza, su cui gli attori camminano bendati per il [THEME].",
                "Una cattedrale di [MATERIAL] che viene costruita e decostruita freneticamente, come il [THEME] stesso.",
                "Un gomitolo gigante di [MATERIAL] che rotola per la scena schiacciando tutto ciò che riguarda il [THEME].",
                "Una bilancia industriale fatta di [MATERIAL] su cui ogni attore deve salire per pesare il proprio [THEME].",
                "Un muro di ghiaccio vero che si scioglie trasformando il palco in una palude di [MATERIAL], metafora del [THEME] liquido.",
                "Una serie di altalene fatte di [MATERIAL] che dondolano a vuoto, cantando il [THEME].",
                "Un organo a canne costruito con [MATERIAL] che suona solo note [ADJ].",
                "Un tappeto volante di [MATERIAL] che non riesce a decollare a causa del [THEME]."
            ],
            
            device_actions: [
                "oscilla pericolosamente", "crolla e viene ricostruita", "perde liquidi scuri", 
                "emette un ronzio assordante", "ruota su se stessa cigolando", "blocca la vista",
                "costringe a camminare carponi", "riflette la luce in modo accecante", "puzza di chiuso",
                "vibra ad ogni passo", "si sgretola lentamente", "gocciola acqua nera", "cigola sinistramente",
                "scricchiola sotto il peso", "intrappola gli attori", "divide lo spazio in due", "incombe dall'alto"
            ],

            cast_groups: [
                "un coro di anziane del quartiere", "un gruppo di richiedenti asilo scalzi", 
                "adolescenti 'neet' in felpa", "ex operai della zona industriale", 
                "madri che reggono foto", "rider delle consegne a domicilio", 
                "studenti fuorisede con valigie", "badanti dell'Est Europa", 
                "bambini vestiti da alberi", "disoccupati che costruiscono muri",
                "operatori ecologici danzanti", "detenuti in permesso premio",
                "ex tossicodipendenti", "burocrati comunali smarriti",
                "rifugiati climatici", "pescatori di rane", "insegnanti precarie",
                "ex dirigenti d'azienda licenziati", "adolescenti hikikomori via webcam",
                "portieri di notte che lavorano a maglia", "giocatori di bocce",
                "operatori di call center urlanti", "condomini litigiosi",
                "attori che fingono di non essere attori", "turisti spaesati con trolley",
                "musicisti di strada senza strumenti", "infermieri in turno di notte",
                "contadini senza terra", "poeti analfabeti", "custodi di cimiteri"
            ],

            cast_notes_templates: [
                "(Nota: I [GROUP] rappresentano la purezza del [THEME], mentre gli altri sono corrotti).",
                "(Nota: Si applica una gerarchia: chi ha subito il [THEME] ha diritto di parola, gli altri tacciono).",
                "(Nota: L'autenticità dei [GROUP] viene usata come scudo contro qualsiasi critica estetica).",
                "(Nota: I [GROUP] non recitano, 'sono'. La loro presenza è un atto di [NOUN] [ADJ]).",
                "(Nota: Il Regista guida i [GROUP] con mano ferma, estraendo da loro il [NOUN] del [THEME]).",
                "(Nota: La voce del migrante deve essere amplificata, quella del cittadino locale sussurrata).",
                "(Nota: I bambini non devono sorridere mai. Rappresentano il futuro tradito del [THEME]).",
                "(Nota: Gli anziani sono trattati come oracoli viventi su troni di [MATERIAL]).",
                "(Nota: Vietato il trucco scenico, le occhiaie devono essere reali per il [THEME]).",
                "(Nota: Il contatto fisico tra gli attori deve essere un 'corpo a corpo' goffo e sudato)."
            ],

            fruition_templates: [
                "Il pubblico deve restare in ginocchio su [MATERIAL] per capire il [THEME].",
                "Gli spettatori devono reggere pesanti pezzi di [MATERIAL] per tutto il tempo.",
                "Si viene bendati e guidati tra ostacoli di [MATERIAL] mentre si ascoltano suoni di [THEME].",
                "L'ingresso è consentito solo dopo aver confessato un peccato legato al [THEME].",
                "Gli spettatori sono stipati in un container pieno di [MATERIAL] per 20 minuti.",
                "Non ci sono sedie: si sta in equilibrio su [MATERIAL] instabili.",
                "Il pubblico viene diviso in 'vittime' e 'carnefici' del [THEME] all'ingresso.",
                "Bisogna tenere le braccia alzate in segno di resa al [THEME].",
                "Il pubblico deve guardare lo spettacolo attraverso il buco della serratura.",
                "Si è costretti a sedere su blocchi di sale grosso per sentire il [THEME].",
                "Bisogna indossare cuffie antirumore e intuire le battute dal labiale.",
                "Gli spettatori sono legati l'uno all'altro con un filo di lana rossa.",
                "L'ingresso avviene strisciando dentro un tubo di areazione smontato.",
                "Si può guardare solo attraverso specchi deformanti.",
                "Bisogna stare su una gamba sola ogni volta che un attore urla [THEME].",
                "Viene vietato di battere le mani alla fine per non rompere l'incantesimo del [THEME].",
                "Ogni spettatore deve tenere in bocca un sasso per sentire il silenzio del [THEME]."
            ],
            
            actions: [
                "leggono i fogli a vista inciampando", "eseguono una danza sgraziata", 
                "ingaggiano un corpo a corpo", "simulano un naufragio", 
                "scrivono sui muri con la saliva", "mangiano documenti ufficiali",
                "corrono in cerchio fino al vomito", "si legano con nastro adesivo",
                "urlano dentro secchi di metallo", "si lavano i piedi con acqua nera",
                "smontano un'auto a mani nude", "fissano il pubblico in silenzio",
                "si scambiano i vestiti freneticamente", "costruiscono torri che crollano",
                "si scambiano le scarpe in un mucchio gigante", "cantano con la testa in secchi d'acqua",
                "si passano un blocco di cemento", "cercano di montare una tenda senza istruzioni",
                "fanno il tiro alla fune cadendo", "si avvolgono nel nastro adesivo",
                "puliscono il pavimento con i vestiti buoni", "simulano una catena di montaggio del nulla",
                "leggono il copione al contrario", "formano scritte umane illeggibili",
                "si mordono le caviglie a vicenda", "mangiano senza posate",
                "recitano correndo su un tapis roulant", "si lanciano farina addosso",
                "si abbracciano fino a soffocare", "camminano all'indietro per un'ora",
                "ripetono la stessa parola finché perde senso", "si coprono di fango a vicenda"
            ],

            interventions: [
                "Il Regista ferma tutto: 'Non recitate! Voglio la verità del [THEME]!'",
                "Il Regista sposta un attore: 'Più urgenza! Il [THEME] non aspetta!'",
                "La finzione si rompe: il Regista interroga un attore sulla sua vita vera.",
                "Il Regista spegne le luci: 'Ascoltate il buio del [THEME]'.",
                "Il Regista mangia in scena mentre gli attori soffrono il [THEME].",
                "Il Regista confessa il suo fallimento nel rappresentare il [THEME].",
                "Il Regista ordina al pubblico di alzarsi e fare un gesto per il [THEME].",
                "Il Regista toglie il microfono all'attrice: 'Bisbiglia. O meglio: pensa'.",
                "Il Regista entra mangiando una mela: 'Fate finta che io non ci sia'.",
                "Il Regista separa due attori: 'La solitudine è igienica'.",
                "Il Regista accende un faro in faccia al protagonista: 'Sii la fotocellula'.",
                "Il Regista ride sguaiatamente: 'Troppo serio. Ricominciate peggio'.",
                "Il Regista si sdraia a terra: 'Calpestatemi'.",
                "Il Regista interrompe il coro: 'Siete troppo intonati'.",
                "Il Regista prende la testa di un attore: 'Pensa a un sasso'."
            ],
            
            actions_prologue: [
                "Il pubblico viene schedato all'ingresso e privato delle scarpe.",
                "Gli spettatori devono entrare strisciando sotto un telo di plastica sporco.",
                "Un attore legge al megafono l'elenco delle sostanze inquinanti.",
                "Viene consegnato a ciascuno un sasso pesante da tenere in mano.",
                "Bisogna compilare un modulo burocratico incomprensibile prima di sedersi.",
                "Gli spettatori vengono bendati e guidati per mano da attori che non parlano.",
                "Viene spruzzato un profumo di 'pioggia acida' addosso a chi entra.",
                "All'ingresso viene timbrata la mano di ogni spettatore con la parola 'COLPEVOLE'.",
                "Si deve camminare sopra le foto della propria città.",
                "Un bambino consegna un frammento di specchio rotto dicendo 'questo sei tu'.",
                "Bisogna attraversare una vasca di acqua gelida a piedi nudi.",
                "Gli spettatori vengono pesati su una bilancia industriale.",
                "Viene chiesto di lasciare i documenti all'ingresso in cambio di un numero."
            ]
        };

        function pick(array) {
            return array[Math.floor(Math.random() * array.length)];
        }
        
        function combine(template, data) {
            let text = template;
            // Sostituzioni base
            text = text.replace(/\[THEME\]/g, data.theme);
            text = text.replace(/\[PLACE\]/g, data.place);
            
            // Sostituzioni grammaticali (sceglie a caso ogni volta che trova il tag)
            // Loop per assicurarsi che se ci sono più tag uguali vengano sostituiti tutti con valori diversi
            const maxLoops = 10;
            let loopCount = 0;
            while ((text.includes("[ADJ]") || text.includes("[NOUN]") || text.includes("[VERB]") || text.includes("[MATERIAL]") || text.includes("[ACTION]") || text.includes("[GROUP]")) && loopCount < maxLoops) {
                text = text.replace("[ADJ]", pick(LEXICON.adj));
                text = text.replace("[NOUN]", pick(LEXICON.noun));
                text = text.replace("[VERB]", pick(LEXICON.verb));
                text = text.replace("[MATERIAL]", pick(LEXICON.materials));
                text = text.replace("[ACTION]", pick(DB.device_actions));
                text = text.replace("[GROUP]", pick(DB.cast_groups));
                loopCount++;
            }
            return text;
        }

        let lastOfflineHtml = "";
        let aiEnabled = false;
        let isEditing = false;

        // --- MODALITÀ OFFLINE: GENERATORE COMBINATORIO ---
        
        function generatePlayOffline() {
            document.getElementById('loadingSection').classList.remove('hidden');
            document.getElementById('outputSection').classList.add('hidden');
            const intervalId = rotateLoadingText();

            setTimeout(() => {
                const theme = document.getElementById('theme').value.trim() || "Il Vuoto";
                const place = document.getElementById('place').value.trim() || "La Periferia";
                const data = { theme, place };
                
                // Generazione Titolo
                const title = `"${pick(DB.titles_prefix)} ${pick(DB.titles_suffix)}"`;
                const subtitle = combine(pick(DB.subtitles_templates), data);

                let html = `<h3>${title}</h3><p><strong>${subtitle}</strong></p>`;
                
                // Luogo
                html += `<h3>IL LUOGO (LA FERITA)</h3><p>${combine(pick(DB.places_templates), data)}</p>`;

                // Dispositivo
                if (document.getElementById('chk_metafore').checked) {
                    html += `<h3>IL DISPOSITIVO (LA METAFORA)</h3><p>${combine(pick(DB.device_templates), data)}</p>`;
                }

                // Video
                if (document.getElementById('chk_video').checked) {
                    html += `<h3>VIDEODISEGNO LIVE</h3><p>Su una superficie di [MATERIAL], un artista disegna in diretta il [NOUN] del [THEME], creando un effetto [ADJ].</p>`.replace("[MATERIAL]", pick(LEXICON.materials)).replace("[NOUN]", pick(LEXICON.noun)).replace(/\[THEME\]/g, theme).replace("[ADJ]", pick(LEXICON.adj));
                }

                // Cast
                html += `<h3>LA COMUNITÀ IN SCENA</h3>`;
                let group1 = pick(DB.cast_groups);
                let group2 = pick(DB.cast_groups);
                while(group1 === group2) group2 = pick(DB.cast_groups); // Evita doppioni
                
                let castText = `Un cast eterogeneo composto da ${group1} e ${group2}.`;
                if (document.getElementById('chk_idealizzazione').checked) {
                    let noteTemplate = pick(DB.cast_notes_templates);
                    noteTemplate = noteTemplate.replace("[GROUP]", group1);
                    castText += ` <br><em>${combine(noteTemplate, data)}</em>`;
                }
                html += `<p>${castText}</p>`;

                // Fruizione
                if (document.getElementById('chk_fruizione').checked) {
                    html += `<h3>FRUIZIONE PUNITIVA</h3><p>${combine(pick(DB.fruition_templates), data)}</p>`;
                }

                // Svolgimento
                html += `<h3>SVOLGIMENTO DELL'AZIONE</h3><ul>`;
                html += `<li><strong>Prologo:</strong> ${pick(DB.actions_prologue)}</li>`;
                
                let actText = combine("Gli attori [VERB] il [MATERIAL] in un atto di [NOUN] collettivo.", data); 
                actText += " " + pick(DB.actions);
                
                if (document.getElementById('chk_estetica').checked) {
                    actText += ` (Nota: La recitazione è volutamente [ADJ] e piena di inciampi per restituire l'urgenza del [THEME]).`.replace("[ADJ]", pick(LEXICON.adj)).replace(/\[THEME\]/g, theme);
                }
                html += `<li><strong>Il Rito Centrale:</strong> ${actText}</li>`;

                if (document.getElementById('chk_patriarcato').checked) {
                    html += `<li><strong>L'Interruzione Maieutica:</strong> ${combine(pick(DB.interventions), data)}</li>`;
                }

                let epiText = "Il pubblico viene invitato a compiere un gesto [ADJ] insieme agli attori.".replace("[ADJ]", pick(LEXICON.adj));
                if (document.getElementById('chk_moralismo').checked) {
                    epiText += ` Un monologo finale spiega che siamo tutti colpevoli del [THEME] e dobbiamo fare [NOUN].`.replace(/\[THEME\]/g, theme).replace("[NOUN]", pick(LEXICON.noun));
                }
                html += `<li><strong>Epilogo:</strong> ${epiText}</li></ul>`;

                clearInterval(intervalId);
                document.getElementById('loadingSection').classList.add('hidden');
                document.getElementById('scriptContent').innerHTML = html;
                document.getElementById('outputSection').classList.remove('hidden');
                lastOfflineHtml = html;
                disableEditing();

            }, 1500);
        }

        // 4. GENERAZIONE ONLINE (OpenAI API - POTENZIATA IBRIDA) ---
        
        async function generatePlayOnline(apiKey, draftHtmlOverride) {
            const theme = document.getElementById('theme').value.trim() || "Il Vuoto";
            const place = document.getElementById('place').value.trim() || "La Periferia";
            
            // COSTRUZIONE BOZZA OFFLINE PER AI (stessa struttura dell'output combinatorio)
            const data = { theme, place };
            const draft_title = `"${pick(DB.titles_prefix)} ${pick(DB.titles_suffix)}"`;
            const draft_subtitle = combine(pick(DB.subtitles_templates), data);
            const draft_place = combine(pick(DB.places_templates), data);
            const draft_device = combine(pick(DB.device_templates), data);
            const draft_cast_group1 = pick(DB.cast_groups);
            let draft_cast_group2 = pick(DB.cast_groups);
            while (draft_cast_group2 === draft_cast_group1) draft_cast_group2 = pick(DB.cast_groups);
            const draft_cast_note = document.getElementById('chk_idealizzazione').checked ? combine(pick(DB.cast_notes_templates).replace("[GROUP]", draft_cast_group1), data) : "";
            const draft_cast = `Un cast eterogeneo composto da ${draft_cast_group1} e ${draft_cast_group2}. ${draft_cast_note}`;
            const draft_punishment = document.getElementById('chk_fruizione').checked ? combine(pick(DB.fruition_templates), data) : "";
            const draft_prologue = pick(DB.actions_prologue);
            const draft_main = combine("Gli attori [VERB] il [MATERIAL] in un atto di [NOUN] collettivo.", data) + " " + pick(DB.actions);
            const draft_director = combine(pick(DB.interventions), data);
            const draft_epilogue = "Il pubblico viene invitato a compiere un gesto [ADJ] insieme agli attori. Un monologo finale spiega che siamo tutti colpevoli del [THEME] e dobbiamo fare [NOUN]."
                .replace("[ADJ]", pick(LEXICON.adj))
                .replace(/\[THEME\]/g, theme)
                .replace("[NOUN]", pick(LEXICON.noun));

            const includeMetafore = document.getElementById('chk_metafore').checked;
            const includeVideo = document.getElementById('chk_video').checked;
            const includeEstetica = document.getElementById('chk_estetica').checked;
            const includePatriarcato = document.getElementById('chk_patriarcato').checked;
            const includeMoralismo = document.getElementById('chk_moralismo').checked;

            let draftHtml = draftHtmlOverride || "";
            if (!draftHtml) {
                draftHtml = `<h3>${draft_title}</h3><p><strong>${draft_subtitle}</strong></p>`;
                draftHtml += `<h3>IL LUOGO (LA FERITA)</h3><p>${draft_place}</p>`;

                if (includeMetafore) {
                    draftHtml += `<h3>IL DISPOSITIVO (LA METAFORA)</h3><p>${draft_device}</p>`;
                }

                if (includeVideo) {
                    const videoChunk = `<h3>VIDEODISEGNO LIVE</h3><p>Su una superficie di [MATERIAL], un artista disegna in diretta il [NOUN] del [THEME], creando un effetto [ADJ].</p>`
                        .replace("[MATERIAL]", pick(LEXICON.materials))
                        .replace("[NOUN]", pick(LEXICON.noun))
                        .replace(/\[THEME\]/g, theme)
                        .replace("[ADJ]", pick(LEXICON.adj));
                    draftHtml += videoChunk;
                }

                draftHtml += `<h3>LA COMUNIT? IN SCENA</h3><p>${draft_cast}</p>`;

                if (draft_punishment) {
                    draftHtml += `<h3>FRUIZIONE PUNITIVA</h3><p>${draft_punishment}</p>`;
                }

                draftHtml += `<h3>SVOLGIMENTO DELL'AZIONE</h3><ul>`;
                draftHtml += `<li><strong>Prologo:</strong> ${draft_prologue}</li>`;
                let ritoCentrale = draft_main;
                if (includeEstetica) {
                    ritoCentrale += ` (Nota: La recitazione ? volutamente [ADJ] e piena di inciampi per restituire l'urgenza del [THEME]).`
                        .replace("[ADJ]", pick(LEXICON.adj))
                        .replace(/\[THEME\]/g, theme);
                }
                draftHtml += `<li><strong>Il Rito Centrale:</strong> ${ritoCentrale}</li>`;
                if (includePatriarcato) {
                    draftHtml += `<li><strong>L'Interruzione Maieutica:</strong> ${draft_director}</li>`;
                }
                let epilogoText = draft_epilogue;
                if (!includeMoralismo) {
                    epilogoText = "Il pubblico viene invitato a compiere un gesto [ADJ] insieme agli attori."
                        .replace("[ADJ]", pick(LEXICON.adj));
                }
                draftHtml += `<li><strong>Epilogo:</strong> ${epilogoText}</li></ul>`;
            }

            const systemPrompt = `
Sei l'Alter Ego Digitale di Pietro Floridia (Regista di Teatro Sociale Impegnato).
Correggi errori di sintassi/grammatica e aumenta la coerenza semantica rispetto al TEMA "${theme}" e al LUOGO "${place}".
Mantieni e accentua il tono parodistico e scomodo del teatro sociale, esagerando i difetti ma restando aderente al tema/luogo.
Lessico obbligatorio da inserire con naturalezza: meticciato, dispositivo, attraversamento, ferita, maieutica, sbiancamento, habitat, humus, corpo a corpo, coagulo, urgenza, restituzione, inciampo, polifonia, sconfinamento, fragilit?, fardello dell'uomo bianco.
Non aggiungere o rimuovere sezioni, non cambiare l'ordine dei tag; non inserire testo fuori dai tag forniti.`;

            const userPromptContent = `
Riscrivi questo HTML mantenendo tag e ordine. Puoi cambiare SOLO il testo interno per correggere grammatica, dare coerenza al tema "${theme}" e al luogo "${place}", e mantenere il tono proletario/brutalista/parodico.
Inserisci dettagli sensoriali coerenti con tema e luogo. Mantieni o esaspera i difetti del teatro sociale.
Ecco il canovaccio da riscrivere:
${draftHtml}
`;

            document.getElementById('loadingSection').classList.remove('hidden');
            document.getElementById('outputSection').classList.add('hidden');
            const intervalId = rotateLoadingText();

            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                    body: JSON.stringify({
                        model: "gpt-3.5-turbo",
                        messages: [
                            { role: "system", content: systemPrompt },
                            { role: "user", content: userPromptContent }
                        ],
                        temperature: 0.65,
                        max_tokens: 700
                    })
                });
                if (!response.ok) throw new Error(`Errore API: ${response.status}`);
                const result = await response.json();
                const aiHtml = result?.choices?.[0]?.message?.content?.trim() || "";
                const hasStructure = aiHtml.includes("<h3") && aiHtml.includes("<ul") && aiHtml.includes("<li");
                if (!hasStructure) throw new Error("Risposta AI non valida, uso modalita' offline.");
                document.getElementById('scriptContent').innerHTML = aiHtml;
                document.getElementById('outputSection').classList.remove('hidden');
                disableEditing();
            } catch (e) {
                alert("Errore AI: " + e.message + ". Uso modalita' offline.");
                generatePlayOffline();
            } finally {
                clearInterval(intervalId);
                document.getElementById('loadingSection').classList.add('hidden');
            }
        }

        // Utils
        function updateMode() {
            const apiKey = document.getElementById('apiKey').value.trim();
            const badge = document.getElementById('modeIndicator');
            if (apiKey.length > 10 && aiEnabled) {
                badge.className = "mode-badge mode-online";
                badge.innerText = "MODALITA' AI (GPT)";
            } else {
                badge.className = "mode-badge mode-offline";
                badge.innerText = "MODALITA' OFFLINE";
            }
            updateAIToggleButton();
        }

        function dispatchGeneration() {
            const apiKey = document.getElementById('apiKey').value.trim();
            if (aiEnabled && apiKey.length > 10) {
                const seedHtml = lastOfflineHtml || document.getElementById('scriptContent').innerHTML.trim();
                generatePlayOnline(apiKey, seedHtml);
            } else {
                aiEnabled = false;
                generatePlayOffline();
                updateMode();
            }
        }

        function rotateLoadingText() {
            const loadingMessages = ["Praticando il meticciato...", "Cercando materiali di scarto...", "Sbiancando la memoria...", "Evocando il disagio...", "Costruendo metafore ingombranti...", "Calcolando il peso dell'assenza..."];
            const textEl = document.getElementById('loadingText');
            let i = 0;
            return setInterval(() => {
                textEl.innerText = loadingMessages[i];
                i = (i + 1) % loadingMessages.length;
            }, 1500);
        }
        
        function updateAIToggleButton() {
            const btn = document.getElementById('aiToggleBtn');
            if (!btn) return;
            btn.innerText = aiEnabled ? "Disattiva IA" : "Attiva IA (GPT)";
            btn.className = aiEnabled
                ? "w-full bg-black text-white font-bold py-2 text-sm border-2 border-red-600 hover:bg-red-600 hover:text-white transition-colors"
                : "w-full bg-red-600 text-white font-bold py-2 text-sm border-2 border-black hover:bg-black hover:text-white transition-colors";
        }

        function toggleAI() {
            const apiKey = document.getElementById('apiKey').value.trim();
            if (!aiEnabled) {
                if (apiKey.length <= 10) {
                    alert("Inserisci una chiave API valida per attivare la IA.");
                    return;
                }
                aiEnabled = true;
                updateMode();
                const existingHtml = lastOfflineHtml || document.getElementById('scriptContent').innerHTML.trim();
                if (existingHtml) {
                    generatePlayOnline(apiKey, existingHtml);
                    return;
                }
            } else {
                aiEnabled = false;
            }
            updateMode();
        }

        function copyToClipboard() {
            const content = document.getElementById('scriptContent').innerText;
            navigator.clipboard.writeText(content).then(() => alert("Copiato!"));
        }
        
        function toggleEditMode() {
            isEditing = !isEditing;
            const contentEl = document.getElementById('scriptContent');
            const hint = document.getElementById('editHint');
            contentEl.contentEditable = isEditing ? "true" : "false";
            contentEl.classList.toggle('ring-2', isEditing);
            contentEl.classList.toggle('ring-red-500', isEditing);
            if (hint) {
                hint.classList.toggle('hidden', !isEditing);
            }
        }

        function disableEditing() {
            const contentEl = document.getElementById('scriptContent');
            const hint = document.getElementById('editHint');
            isEditing = false;
            contentEl.contentEditable = "false";
            contentEl.classList.remove('ring-2', 'ring-red-500');
            if (hint) hint.classList.add('hidden');
        }

        function saveEditedContent() {
            const contentEl = document.getElementById('scriptContent');
            lastOfflineHtml = contentEl.innerHTML;
            disableEditing();
            alert("Modifiche salvate nella sessione corrente.");
        }

        function exportPDF() {
            const contentHtml = document.getElementById('scriptContent').innerHTML;
            const w = window.open('', '_blank', 'width=800,height=1000');
            if (!w) return;
            w.document.write(`
                <html><head><title>Progetto Teatro Sociale</title>
                <style>
                    body { font-family: 'Courier Prime', monospace; padding: 24px; }
                    h3 { font-family: 'Oswald', sans-serif; text-transform: uppercase; background: #000; color: #fff; display:inline-block; padding: 4px 8px; }
                    strong { background: #ff0; }
                </style>
                </head><body>${contentHtml}</body></html>
            `);
            w.document.close();
            w.focus();
            w.print();
        }

        updateAIToggleButton();
    </script>
</body>
</html>
